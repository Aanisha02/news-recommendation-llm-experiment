#Code generated by ChatGPT, OpenAI, November 11, 2025, https://chat.openai.com/chat


import random
from pathlib import Path

import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split

ROOT = Path(__file__).resolve().parents[1]
RAW_DIR = ROOT / "dataset" / "gossipcop_raw"
OUT_DIR = ROOT / "dataset" / "gossipcop"

OUT_DIR.mkdir(parents=True, exist_ok=True)

# how many negatives per impression (clicked + N_NEG unclicked)
N_NEG = 5

def main():
    fake_path = RAW_DIR / "gossipcop_fake.csv"
    real_path = RAW_DIR / "gossipcop_real.csv"

    print(f"Reading: {fake_path}")
    fake = pd.read_csv(fake_path)

    print(f"Reading: {real_path}")
    real = pd.read_csv(real_path)

    # label: 0 = fake, 1 = real
    fake["label"] = 0
    real["label"] = 1

    df = pd.concat([fake, real]).reset_index(drop=True)

    # ---- standardize columns ----
    if "news_id" not in df.columns:
        df["news_id"] = ["N" + str(i) for i in range(len(df))]

    if "category" not in df.columns:
        df["category"] = "news"

    if "subcategory" not in df.columns:
        df["subcategory"] = "gossipcop"

    if "abstract" not in df.columns:
        df["abstract"] = df["title"]

    if "url" not in df.columns:
        df["url"] = ""

    df["title_entities"] = "[]"
    df["abstract_entities"] = "[]"

    # deterministic splits
    train_df, temp = train_test_split(df, test_size=0.2, random_state=42, shuffle=True)
    val_df, test_df = train_test_split(temp, test_size=0.5, random_state=42, shuffle=True)

    def save_split(split_df: pd.DataFrame, split_name: str):
        split_dir = OUT_DIR / split_name
        split_dir.mkdir(parents=True, exist_ok=True)

        news_path = split_dir / "news.tsv"
        behaviors_path = split_dir / "behaviors.tsv"

        # ---- news.tsv with label ----
        news_cols = [
            "news_id",
            "category",
            "subcategory",
            "title",
            "abstract",
            "url",
            "title_entities",
            "abstract_entities",
            "label",
        ]
        split_df[news_cols].to_csv(news_path, sep="\t", index=False)

        # ---- behaviors.tsv: 1 clicked + N_NEG unclicked ----
        all_ids = split_df["news_id"].tolist()
        behaviors = []

        for i, row in enumerate(split_df.itertuples(index=False), start=1):
            pos_id = row.news_id
            # choose negatives from same split, excluding the positive
            neg_pool = [nid for nid in all_ids if nid != pos_id]
            neg_ids = random.sample(neg_pool, k=min(N_NEG, len(neg_pool)))

            impressions_tokens = [f"{pos_id}-1"] + [f"{nid}-0" for nid in neg_ids]
            impressions_str = " ".join(impressions_tokens)

            impression_id = i
            user_id = f"U{pos_id[1:]}"   # e.g. N123 -> U123
            time_str = "2019-11-11 00:00:00"
            history_str = ""             # empty history for simplicity

            behaviors.append(
                [impression_id, user_id, time_str, history_str, impressions_str]
            )

        beh_df = pd.DataFrame(
            behaviors,
            columns=["impression_id", "user_id", "time", "history", "impressions"],
        )
        beh_df.to_csv(behaviors_path, sep="\t", index=False)

        print(f"Saved {news_path}  ({len(split_df)} rows)")
        print(f"Saved {behaviors_path}  ({len(split_df)} rows)")

    save_split(train_df, "train")
    save_split(val_df, "val")
    save_split(test_df, "test")

    print("DONE: converted GossipCop to MIND-style format with label and multi-candidate behaviors.")


if __name__ == "__main__":
    main()
